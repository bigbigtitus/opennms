#!/usr/bin/env bash

set -e
set -o pipefail

FORCE=0
RECURSE=1

while getopts fhR OPT; do
  case "${OPT}" in
    h)
      echo "usage: $0 [-h] [-R] [-f] [file...]"
      echo ""
      echo "  -h    this help"
      echo ""
      echo "  -f    change ownership regardless of current \$RUNAS"
      echo "  -R    do not recurse"
      echo ""
      exit 1
      ;;
    f)
      FORCE=1
      ;;
    R)
      RECURSE=0
      ;;
    *)
      ;;
  esac
done
shift $((OPTIND -1))

if [ -z "${OPENNMS_HOME}" ]; then
  # shellcheck disable=SC2016,SC2154
  OPENNMS_HOME='${install.dir}'
fi

if [ -e "${OPENNMS_HOME}/etc/opennms.conf" ]; then
  # shellcheck disable=SC1090,SC1091
  . "${OPENNMS_HOME}/etc/opennms.conf"
else
  RUNAS=opennms
fi

if [ -z "${RUNAS}" ]; then
  echo "Something is very wrong, \$RUNAS is not set. Bailing."
  exit 1
fi

if [ "${RUNAS}" != "opennms" ] && [ "${FORCE}" -eq 0 ]; then
  echo "\$RUNAS has been changed from the default 'opennms' user. Assuming you know what you're doing and _not_ changing ownership of any files."
  echo ""
  echo "If you want to use this script to change everything to '${RUNAS}', pass the -f flag:"
  echo "$0 -f"
  echo ""
  exit 0
fi

RUNAS_UID="$(id -u "${RUNAS}" 2>/dev/null || :)"
RUNAS_GID="$(id -g "${RUNAS}" 2>/dev/null || :)"

if [ -z "${RUNAS_UID}" ] || [ -z "${RUNAS_GID}" ]; then
  echo "ERROR: unable to determine UID and GID from \$RUNAS=${RUNAS}. Bailing."
  exit 1
fi

SUDO="$(command -v sudo 2>/dev/null || which sudo 2>/dev/null || :)"

do_chown() {
  _mypath="$1"

  if [ -x "$SUDO" ]; then
    "$SUDO" chown "${RUNAS_UID}:${RUNAS_GID}" "${_mypath}"
  else
    chown "${RUNAS_UID}:${RUNAS_GID}" "${_mypath}"
  fi
}

recursive_chown() {
  _mydir="$1"

  if [ ! -d "${_mydir}" ]; then
    return 0
  fi

  # just in case :)
  if [ "${_mydir}" = "/" ]; then
    echo "ERROR: trying to chown / -- something is very broken. Bailing."
    return 1
  fi

  if [ -d "${_mydir}" ]; then
    echo "* fixing ownership of ${_mydir}"
    if [ -x "$SUDO" ]; then
      sudo chown "${RUNAS_UID}:${RUNAS_GID}" "${_mydir}"
      if [ "$RECURSE" -eq 1 ]; then
        find -L -x "${_mydir}" ! -user "${RUNAS_UID}" -print0 | "$SUDO" xargs -0 chown "${RUNAS_UID}:${RUNAS_GID}"
      fi
    else
      chown "${RUNAS_UID}:${RUNAS_GID}" "${_mydir}"
      if [ "$RECURSE" -eq 1 ]; then
        find -L -x "${_mydir}" ! -user "${RUNAS_UID}" -print0 | xargs -0 chown "${RUNAS_UID}:${RUNAS_GID}"
      fi
    fi
  else
    echo "! skipping ${_mydir} -- it is not a directory"
  fi
}

if [ -n "$1" ]; then
  # user has passed specific files to change
  for CHANGEME in "$@"; do
    if [ -d "$CHANGEME" ]; then
      recursive_chown "$CHANGEME"
    else
      do_chown "$CHANGEME"
    fi
  done
  exit 0
fi

recursive_chown "${OPENNMS_HOME}/"
find "${OPENNMS_HOME}"/* -type l -maxdepth 0 | while read -r SUBDIR; do
  recursive_chown "${SUBDIR}/"
done

for TOOL in opennms minion sentinel; do
  for TOOLFILE in "/etc/default/${TOOL}" "/etc/sysconfig/${TOOL}"; do
    if [ -e "${TOOLFILE}" ]; then
      echo "* fixing ownership of ${TOOLFILE}"
      do_chown "${TOOLFILE}"
    fi
  done
done
